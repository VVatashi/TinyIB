!function(t){var e={};function s(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,o){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(o,n,function(e){return t[e]}.bind(null,n));return o},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=11)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.qid=function(t){return document.getElementById(t)},e.qs=function(t,e=null){return e||(e=document),e.querySelector(t)},e.qsa=function(t,e=null){e||(e=document);const s=e.querySelectorAll(t);return Array.prototype.slice.call(s)}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(2),n=s(0);e.default=class extends o.default{constructor(t){super(t)}processPost(t){}onReady(){const t=n.qsa(".post"),e=t.length;for(let s=0;s<e;++s)this.processPost(t[s])}onPostInsert(t){this.processPost(t)}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.default=class{constructor(t){this.manager=t}onReady(){}onResize(){}onPostInsert(t){}onEvent(t,e){}}},function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,e,s,o){return new(s||(s=Promise))(function(n,r){function a(t){try{d(o.next(t))}catch(t){r(t)}}function i(t){try{d(o.throw(t))}catch(t){r(t)}}function d(t){t.done?n(t.value):new s(function(e){e(t.value)}).then(a,i)}d((o=o.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const n=s(1),r=s(0);e.default=class extends n.default{constructor(){super(...arguments),this.viewModel=null,this.interval=10,this.latestPostId=0,this.isUpdating=!1}onReady(){super.onReady();const t=r.qs(".thread");t&&0==+t.getAttribute("data-thread-page")&&(this.viewModel=new window.Vue({el:"#thread-updater",template:'\n<div class="thread-updater thread__updater">\n  <button class="thread-updater__update" v-on:click="updateThread">Update</button>\n\n  <label class="thread-updater__auto">\n    <input type="checkbox" class="thread-updater__auto-checkbox" v-on:change="counter = module.interval" v-model="isAuto" />\n    Auto\n    <span class="thread-updater__auto-counter" v-if="isAuto">\n      {{ counter }}\n    </span>\n  </label>\n\n  <span class="thread-updater__updating" v-if="module.isUpdating">Updating...</span>\n</div>',data:{module:this,isAuto:!0,isUpdating:!1,counter:this.interval,intervalId:NaN},methods:{onTick(){this.isAuto&&(this.counter>0?this.counter--:this.updateThread())},updateThread(){this.counter=this.module.interval,this.module.updateThread()}},mounted(){this.intervalId=setInterval(this.onTick,1e3)},beforeDestroy(){NaN!==this.intervalId&&clearInterval(this.intervalId)}}))}onEvent(t){if("updateThread"===t){const t=this.viewModel.isAuto;this.viewModel.isAuto=!1,this.viewModel.counter=this.interval,this.updateThread(),this.viewModel.isAuto=t}}processPost(t){const e=+t.getAttribute("data-post-id");this.latestPostId=Math.max(this.latestPostId,e)}updateThread(){return o(this,void 0,void 0,function*(){if(this.isUpdating)return;const t=r.qs(".thread");if(!t)return;this.isUpdating=!0;const e=r.qs(".thread__posts",t);if(e){const s=+t.getAttribute("data-thread-id"),o=this.latestPostId,n=yield fetch(`${window.baseUrl}/ajax/mobile/thread/${s}?after=${o}`);if(n.status<400){const t=yield n.text();e.insertAdjacentHTML("beforeend",t);const s=r.qsa(".post",e).filter(t=>+t.getAttribute("data-post-id")>o);s.forEach(t=>t.classList.add("fadable","fade")),setTimeout(()=>{s.forEach(t=>t.classList.remove("fade"))},100),this.manager.insertPosts(s);const a=r.qsa(".thread__post",e);for(let t=0;t<a.length-50;++t)a[t].remove()}}this.isUpdating=!1})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(1),n=s(0);e.default=class extends o.default{constructor(t){super(t),this.user={},this.posts={},this.user.name=localStorage.getItem("user.name"),this.user.tripcode=localStorage.getItem("user.tripcode")}getPostAuthor(t){const e=n.qs(".post__name",t),s=n.qs(".post__tripcode",t);return{name:e?e.textContent:"",tripcode:s?s.textContent:""}}getPostRefLinkHtml(t){const e=+t.getAttribute("data-post-id"),s=n.qs(".post__name",t),o=n.qs(".post__tripcode",t),r=s?s.innerHTML:"",a=o?o.innerHTML:"";return r.length||a.length?`<span class="post__reference-link-id">&gt;&gt;${e}</span>`+' <span class="post__reference-link-author">'+`(<span class="post__reference-link-name">${r}</span>`+`<span class="post__reference-link-tripcode">${a}</span>)`+"</span>":`<span class="post__reference-link-id">&gt;&gt;${e}</span>`}processPost(t){const e=+t.getAttribute("data-post-id");this.posts[e]=t;const s=n.qsa("a[data-target-post-id]",t).map(t=>({element:t,id:+t.getAttribute("data-target-post-id")})),o=s.filter((t,e)=>s.indexOf(t)===e).map(t=>this.posts[t.id]).filter(t=>t);s.forEach(t=>{const e=this.posts[t.id];e&&(t.element.innerHTML=this.getPostRefLinkHtml(e))});const r=this.getPostAuthor(t);(this.user.tripcode&&this.user.tripcode.length&&this.user.tripcode===r.tripcode||this.user.name&&this.user.name.length&&this.user.name===r.name)&&t.classList.add("post_own"),o.forEach(s=>{let o=n.qs(".post__footer",s);o||((o=document.createElement("div")).classList.add("post__footer"),s.appendChild(o));const r=document.createElement("a");r.classList.add("post__reference-link"),r.href=`#post_${e}`;const a=this.getPostAuthor(s);(this.user.tripcode&&this.user.tripcode.length&&this.user.tripcode===a.tripcode||this.user.name&&this.user.name.length&&this.user.name===a.name)&&t.classList.add("post_own-reply"),r.innerHTML=this.getPostRefLinkHtml(t),o.appendChild(r)})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(1),n=s(0);e.default=class extends o.default{constructor(t){super(t)}processPost(t){const e=n.qs(".post__id-link",t);e&&e.addEventListener("click",t=>{t.preventDefault();const s=e.getAttribute("data-post-id");return this.manager.emit("insertMarkup",[`>>${s}\n`,"",!0]),!1})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(1),n=s(0);e.default=class extends o.default{constructor(t){super(t),this.scale=1,this.offsetX=0,this.offsetY=0,this.dragStartOffsetX=0,this.dragStartOffsetY=0,this.dragStartMouseX=0,this.dragStartMouseY=0}closeModal(t){this.scale=1,this.offsetX=0,this.offsetY=0,t.classList.add("fade"),setTimeout(()=>{t.remove()},333)}transformModal(t){n.qs(".modal__image",t).style.transform=`translate(${this.offsetX}px, ${this.offsetY}px) scale(${this.scale})`}openModal(t){let e;const s=t.getAttribute("data-file-type");if("video"===s){const s=document.createElement("video"),o=t.getAttribute("data-file-width"),n=t.getAttribute("data-file-height");s.classList.add("modal__video"),s.setAttribute("controls","controls"),s.setAttribute("preload","metadata"),s.setAttribute("width",o),s.setAttribute("height",n),s.src=t.href,e=s}else if("audio"===s){const s=document.createElement("audio");s.classList.add("modal__audio"),s.setAttribute("controls","controls"),s.setAttribute("preload","metadata"),s.src=t.href,e=s}else{const s=document.createElement("img");s.classList.add("modal__image"),s.src=t.href,e=s}e.addEventListener("dragstart",t=>(t.preventDefault(),!1)),e.addEventListener("click",t=>(t.preventDefault(),t.stopPropagation(),!1)),e.addEventListener("mousedown",t=>{t.preventDefault(),this.dragStartOffsetX=this.offsetX,this.dragStartOffsetY=this.offsetY,this.dragStartMouseX=t.pageX,this.dragStartMouseY=t.pageY;const s=t=>{t.preventDefault();const e=t.pageX-this.dragStartMouseX,s=t.pageY-this.dragStartMouseY;return this.offsetX=this.dragStartOffsetX+e,this.offsetY=this.dragStartOffsetY+s,this.transformModal(o),!1},n=t=>(t.preventDefault(),document.removeEventListener("mousemove",s),e.removeEventListener("mouseup",n),(Math.abs(this.offsetX-this.dragStartOffsetX)<.01||Math.abs(this.offsetY-this.dragStartOffsetY)<.01)&&this.closeModal(o),!1);return document.addEventListener("mousemove",s),e.addEventListener("mouseup",n),!1});const o=document.createElement("div");o.classList.add("layout__modal","modal"),o.appendChild(e),o.addEventListener("click",t=>(t.preventDefault(),this.closeModal(o),!1)),o.addEventListener("wheel",t=>(t.preventDefault(),this.scale=(1-.1*Math.sign(t.deltaY))*this.scale,this.transformModal(o),!1)),t.parentElement.appendChild(o),o.classList.add("fadable","fade"),setTimeout(()=>{o.classList.remove("fade")},100)}processPost(t){const e=n.qs(".post__thumbnail-link",t);e&&e.addEventListener("click",t=>(t.preventDefault(),this.openModal(e),!1))}}},function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,e,s,o){return new(s||(s=Promise))(function(n,r){function a(t){try{d(o.next(t))}catch(t){r(t)}}function i(t){try{d(o.throw(t))}catch(t){r(t)}}function d(t){t.done?n(t.value):new s(function(e){e(t.value)}).then(a,i)}d((o=o.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const n=s(2),r=s(0);e.default=class extends n.default{constructor(t){super(t)}insertMarkup(t,e,s,o=!1){const n=t.value,r=t.selectionStart,a=t.selectionEnd,i=n.substring(0,r),d=n.substring(r,a),c=n.substring(a);o&&i.length&&!i.endsWith("\n")&&(e=`\n${e}`),t.value=[i,e,d,s,c].join(""),t.focus(),t.selectionStart=r+e.length,t.selectionEnd=r+e.length+(a-r)}insertBBCode(t,e){return this.insertMarkup(t,`[${e}]`,`[/${e}]`)}onReady(){const t=r.qid("postform");if(!t)return void console.warn("#postform is not found.");const e=r.qs("#subject",t);if(e){const t=localStorage.getItem("postform.subject");t&&(e.value=t),e.addEventListener("change",t=>{localStorage.setItem("postform.subject",e.value)})}const s=r.qs("#name",t);if(s){const t=localStorage.getItem("postform.name");t&&(s.value=t),s.addEventListener("change",t=>{localStorage.setItem("postform.name",s.value)})}const n=r.qs("#email",t);if(n){const t=localStorage.getItem("postform.email");t&&(n.value=t),n.addEventListener("change",t=>{localStorage.setItem("postform.email",n.value)})}const a=r.qs("#message",t);if(a){const e={"postform-markup-bold":t=>this.insertBBCode(a,"b"),"postform-markup-italic":t=>this.insertBBCode(a,"i"),"postform-markup-underline":t=>this.insertBBCode(a,"u"),"postform-markup-strike":t=>this.insertBBCode(a,"s"),"postform-markup-sup":t=>this.insertBBCode(a,"sup"),"postform-markup-sub":t=>this.insertBBCode(a,"sub"),"postform-markup-spoiler":t=>this.insertBBCode(a,"spoiler"),"postform-markup-rp":t=>this.insertBBCode(a,"rp"),"postform-markup-code":t=>this.insertBBCode(a,"code"),"postform-markup-quote":t=>this.insertMarkup(a,">","",!0)};Object.keys(e).forEach(s=>{const o=r.qs(`#${s}`,t);o&&o.addEventListener("click",e[s])})}const i=r.qsa("#file",t);i.forEach(t=>{t.addEventListener("change",e=>{if(t.files&&t.files.length){const e=new FileReader;e.addEventListener("load",e=>{const s=t.parentElement;let o=r.qs(".form__file-preview",s);o||((o=document.createElement("img")).classList.add("form__file-preview"),s.appendChild(o)),o.src=e.target.result}),e.readAsDataURL(t.files[0])}})}),t.addEventListener("submit",e=>o(this,void 0,void 0,function*(){e.preventDefault();const s=new FormData(t),o=yield fetch(`${window.baseUrl}/ajax/mobile/post/create`,{method:"POST",body:s});if(0===r.qsa(".thread").length&&o.headers.has("Location")&&(window.location.href=o.headers.get("Location")),o.status<400){a.value="",i.forEach(t=>{t.type="text",t.value="",t.type="file"}),r.qsa(".form__file-preview",t).forEach(t=>t.remove());const e=yield o.json();e.name?localStorage.setItem("user.name",e.name):localStorage.removeItem("user.name"),e.tripcode?localStorage.setItem("user.tripcode",e.tripcode):localStorage.removeItem("user.tripcode"),this.manager.emit("updateThread")}else console.error(o)}))}onEvent(t,e){if("insertMarkup"===t){const t=r.qid("postform");if(!t)return void console.warn("#postform is not found.");const s=r.qs("#message",t);if(!s)return void console.warn("#message is not found.");e.unshift(s),this.insertMarkup.apply(this,e)}}}},function(t,e){t.exports=luxon},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(1),n=s(0),r=s(8);e.default=class extends o.default{constructor(t){super(t)}processPost(t){const e=n.qs(".post__date",t);if(e){const t=e.getAttribute("datetime"),s=r.DateTime.fromISO(t);e.textContent=s.toLocaleString(r.DateTime.DATETIME_MED_WITH_SECONDS)}}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(0);e.default=class{constructor(t=!1){if(this.modules={},t){const t=new MutationObserver(t=>{const e=t.map(t=>{const e=t.addedNodes;return Array.prototype.slice.call(e).filter(t=>t.nodeType===Node.ELEMENT_NODE).map(t=>t.classList.contains("post")?[t]:o.qsa(".post",t)).reduce((t,e)=>t.concat(e),[])}).reduce((t,e)=>t.concat(e),[]);e.length>0&&this.insertPosts(e)});document.addEventListener("DOMContentLoaded",()=>{t.observe(document.body,{childList:!0,subtree:!0})})}document.addEventListener("DOMContentLoaded",()=>{this.forEachModule((t,e)=>new Promise((s,o)=>{try{e.onReady()}catch(e){console.error(`Error in ${t}.onReady(): ${e}`),o(e)}s()}))}),window.addEventListener("resize",()=>{this.forEachModule((t,e)=>new Promise(()=>{try{e.onResize()}catch(e){console.error(`Error in ${t}.onResize(): ${e}`)}}))})}forEachModule(t){return Object.keys(this.modules).map(e=>{const s=this.modules[e];return t(e,s)})}addModule(t,e){this.modules[t]=e}emit(t,e){this.forEachModule((s,o)=>new Promise(()=>{try{o.onEvent(t,e)}catch(e){console.error(`Error in ${s}.onEvent(${t}): ${e}`)}}))}insertPosts(t){console.debug("Inserted posts: ",t),this.forEachModule((e,s)=>new Promise((o,n)=>{try{t.forEach(t=>s.onPostInsert(t))}catch(t){console.error(`Error in ${e}.onPostInsert(): ${t}`),n(t)}o()}))}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=s(10),n=s(9),r=s(7),a=s(6),i=s(5),d=s(4),c=s(3),u=new o.default;u.addModule("PostCorrectTime",new n.default(u)),u.addModule("PostForm",new r.default(u)),u.addModule("PostImagePopup",new a.default(u)),u.addModule("PostQuote",new i.default(u)),u.addModule("PostReferenceMap",new d.default(u)),u.addModule("ThreadUpdater",new c.default(u)),window.tinyib={},window.tinyib.moduleManager=u}]);