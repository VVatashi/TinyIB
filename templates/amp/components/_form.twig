<amp-state id="formState" src="{{ base_url }}/amp/form-state">
  <script type="application/json">
{
  "newLine": "\n",
  "subject": "",
  "name": "",
  "email": "",
  "message": "",
  "filename": "Upload file."
}
  </script>
</amp-state>

<form id="form" class="thread__form form" method="POST" target="_top"
  action-xhr="{{ base_url }}/amp/post{{ name ? '?name=' ~ name }}" on="tap:AMP.setState({})">

  <input type="hidden" name="parent" value="{{ parent|default(0) }}" />

  <div class="form__row">
    <label class="form__field">
      <input type="text" id="subject" class="form__input" placeholder="Subject"
        name="subject" [value]="formState.subject" />
    </label>

    <label class="form__field">
      <input type="text" id="name" class="form__input" placeholder="Name"
        name="name" [value]="formState.name" />
    </label>

    <label class="form__field">
      <input type="text" id="email" class="form__input" placeholder="Email"
        name="email" [value]="formState.email" />
    </label>

    <div class="form__field phone-hidden">
      <button type="submit" class="form__button button">Submit</button>
    </div>
  </div>

  <div class="form__row form__row--markup">
    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[b]') > formState.message.lastIndexOf('[/b]') ? '[/b]' : '[b]')} }),message.focus">Bold</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[i]') > formState.message.lastIndexOf('[/i]') ? '[/i]' : '[i]')} }),message.focus">Italic</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[u]') > formState.message.lastIndexOf('[/u]') ? '[/u]' : '[u]')} }),message.focus">Underline</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[s]') > formState.message.lastIndexOf('[/s]') ? '[/s]' : '[s]')} }),message.focus">Strike</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[sup]') > formState.message.lastIndexOf('[/sup]') ? '[/sup]' : '[sup]')} }),message.focus">Sup</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[sub]') > formState.message.lastIndexOf('[/sub]') ? '[/sub]' : '[sub]')} }),message.focus">Sub</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[spoiler]') > formState.message.lastIndexOf('[/spoiler]') ? '[/spoiler]' : '[spoiler]')} }),message.focus">Spoiler</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.lastIndexOf('[rp]') > formState.message.lastIndexOf('[/rp]') ? '[/rp]' : '[rp]')} }),message.focus">RP</button>
    </div>

    <div class="form__field">
      <button type="button" class="form__button button" on="tap:AMP.setState({formState: {message: formState.message + (formState.message.length > 0 ? formState.newLine : '') + '>'} }),message.focus">Quote</button>
    </div>
  </div>

  <div class="form__row">
    <label class="form__field">
      <textarea id="message" class="form__textarea" placeholder="Message"
        name="message" [text]="formState.message"
        on="change:AMP.setState({formState: {message: event.value} });tap:AMP.setState({formState: {message: formState.message} })">
      </textarea>
    </label>
  </div>

  <div class="form__row">
    <label class="form__field input">
      <input type="file" id="file" class="form__file" placeholder="File" name="file" value=""
        on="change:AMP.setState({formState: {filename: event.value.split('\').slice(-1)[0]} })" />

      <span class="form__input" [text]="formState.filename">Upload file.</span>
    </label>
  </div>

  <div class="form__row phone-only">
    <div class="form__field">
      <button type="submit" class="form__button button">Submit</submit>
    </div>
  </div>

  <div class="form__message" submitting>
    <span>Submitting post...</span>
  </div>

  <div class="form__message form__message--error" submit-error>
    <template type="amp-mustache">
      {% verbatim %}{{error}}{% endverbatim %}
    </template>
  </div>
</form>
